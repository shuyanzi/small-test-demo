<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width" />
    <title>ncnn webassembly liveness</title>
    <style>
        video {
            /*             position: absolute; */
            /*             visibility: hidden; */
        }

        canvas, video {
            width: 200px;
            border: 1px solid black;
        }
    </style>

</head>

<body>
    <div>
        <h1>ncnn webassembly liveness</h1>
        bash
        <br>
        sh platforms/wasm/build_sdk.sh liveness && rm -r /Users/work/fe/small-test-demo/build-wasm-example && mv build-wasm-example /Users/work/fe/small-test-demo
        <div id="config" style="height:48px"> </div>
        <div id="liveness-stage" style="height:48px"> </div>
        <div id="error-code" style="height:48px"> </div>
        <div>
            <button disabled id="switch-camera-btn" style="height:48px">Switch Camera</button>
            <button disabled id="init-btn" style="height:48px">Init</button>
            <button disabled id="reset-btn" style="height:48px">reset</button>
        </div>
        <div id="hint" style="height:48px">
        </div>
        <!-- <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br> -->
        <div>
            <canvas id="canvas" width="640" height="640"></canvas>
        </div>
        <video id="video" playsinline autoplay></video>
    </div>

    <!-- <script src="wasmFeatureDetect.js"></script> -->
    <script>
        // wasm feature detect
        !function (e, t) { "object" == typeof exports && "undefined" != typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define(t) : (e = "undefined" != typeof globalThis ? globalThis : e || self).wasmFeatureDetect = t() }(this, (function () { "use strict"; return { simd: function () { return Promise.resolve(WebAssembly.validate(new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 5, 1, 96, 0, 1, 123, 3, 2, 1, 0, 10, 10, 1, 8, 0, 65, 0, 253, 15, 253, 98, 11]))) } } }));
      </script>

    <script type='text/javascript'>
        const CONFIG = {
            //
            ellipseMatchXDelta: '0.1',
            ellipseMatchYDelta: '0.15',
            ellipseFaceWidthDeltaRatio: '0.1',
            // distant face ellipse parameters
            ellipseXMin: '0.3',
            ellipseXMax: '0.7',
            ellipseYMax: '0.8',
            // ellipseXMax_return_by_acv_get_config = ellipseXMax + (ellipseMatchXDelta / 2)

            // close face ellipse parameters
            // ellipseXMax_face_near = (ellipseXMax - 0.5) * ellipseEnlargeRatio
            // minimal ratio > 1.35
            ellipseEnlargeRatio: '1.4',
            // i.e. close face's ellipseMatchXDelta: '0.1',
            largeModeEllipseMatchXDelta: '0.2',
            // i.e. close face's ellipseYMax: '0.8',
            largeModeEllipseYMax: '1',

            faceOcclusionThresholdV2: '0.99',
            outerEllipseXDelta: '0.15',
            outerEllipseYDelta: '0.2',
        }
        var Module = {};

        var has_simd;

        var wasmModuleLoaded = false;
        var wasmModuleLoadedCallbacks = [];

        Module.locateFile = function (s) {
            return (
                `build-wasm-example/` + s
            )
        }
        Module.onRuntimeInitialized = function () {
            wasmModuleLoaded = true;
            for (var i = 0; i < wasmModuleLoadedCallbacks.length; i++) {
                wasmModuleLoadedCallbacks[i]();
            }
        }

        wasmFeatureDetect.simd().then(simdSupported => {
            has_simd = simdSupported;

            // wasmFeatureDetect.threads().then(threadsSupported => {

                if (has_simd) {
                    liveness_module_name = 'liveness-simd';
                } else {
                    liveness_module_name = 'liveness-basic';
                }

                var livenesswasm = '/build-wasm-example/' + liveness_module_name + '.wasm';
                var livenessjs = '/build-wasm-example/' + liveness_module_name + '.js';

                fetch(livenesswasm)
                    .then(response => response.arrayBuffer())
                    .then(buffer => {
                        setTimeout(() => {
                            console.log({buffer}, window._acv_detect_init)
                            window._acv_detect_init()
                        }, 1000)
                        Module.wasmBinary = buffer;
                        var script = document.createElement('script');
                        script.src = livenessjs;
                        script.onload = function () {
                        }
                        document.body.appendChild(script);
                        var btn = document.getElementById('init-btn');
                        btn.disabled = false;
                    });

            // });
        });

        var shouldFaceUser = true;
        var stream = null;
        var w = 640;
        var h = 640;

        var dst = null;
        var resultarray = null;
        var resultbuffer = null;

        function native_read_string(ptr) {
            var output = UTF8ToString(ptr)
            _free(ptr);
            return output;
        }

        window.addEventListener('DOMContentLoaded', async function () {
            var isStreaming = false;
            switchcamerabtn = document.getElementById('switch-camera-btn');
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            // Wait until the video stream canvas play
            video.addEventListener('canplay', function (e) {
                if (!isStreaming) {
                    // videoWidth isn't always set correctly in all browsers
                    if (video.videoWidth > 0) h = video.videoHeight / (video.videoWidth / w);
                    canvas.setAttribute('width', w);
                    canvas.setAttribute('height', h);
                    isStreaming = true;
                }
            }, false);

            // Wait for the video to start to play
            video.addEventListener('play', function () {
                //Setup image memory
                var id = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var d = id.data;
                console.log({wasmModuleLoaded})
                if (wasmModuleLoaded) {
                    mallocAndCallSFilter();
                } else {
                    wasmModuleLoadedCallbacks.push(mallocAndCallSFilter);
                }

                function mallocAndCallSFilter() {
                    if (dst != null) {
                        _free(dst);
                        dst = null;
                    }

                    dst = _malloc(d.length);

                    // console.log('window.navigator.userAgent1', window.navigator.userAgent);
                    // const userAgent = window.btoa(JSON.stringify({ua: window.navigator.userAgent}));
                    // const intArray = window.intArrayFromString(userAgent);
                    // const ptr = _malloc(intArray.length);
                    // Module.HEAPU8.set(intArray, ptr);
                    // Module._setInfo(ptr)
                    // Module._free(ptr);
                    // console.log('sFilter window.navigator.userAgent1', window.navigator.userAgent);
                    sFilter();
                    // save_info()
                }
            });

            // check whether we can use facingMode
            var supports = navigator.mediaDevices.getSupportedConstraints();
            if (supports['facingMode'] === true) {
                switchcamerabtn.disabled = false;
            }

            switchcamerabtn.addEventListener('click', function () {
                if (stream == null)
                    return

                stream.getTracks().forEach(t => {
                    t.stop();
                });

                shouldFaceUser = !shouldFaceUser;
                capture();
            });

            var initBtn = document.getElementById('init-btn');
            var configDiv = document.getElementById('config');
            var resetBtn = document.getElementById('reset-btn');
            initBtn.addEventListener('click', function () {
                const configText = btoa(JSON.stringify(CONFIG));
                const intArray = intArrayFromString(configText);
                const ptr = _malloc(intArray.length);
                HEAPU8.set(intArray, ptr);

                const err = _acv_init(ptr);
                if (err) {
                    var errText = UTF8ToString(err);
                    _free(errText);
                }
                _free(ptr);

                var c = _acv_get_config();
                configDiv.innerHTML = native_read_string(c);
                resetBtn.disabled = false;
            });

            resetBtn.addEventListener('click', function () {
                _acv_reset();
            });
            // capture();
            
        });

        function test() {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    resolve(123312);
                }, 3000);
            })
        }

        async function capture() {
            var constraints = {
                audio: false,
                video: {
                    width: 640,
                    height: 480,
                    facingMode: shouldFaceUser ? 'user' : 'environment'
                }
            };
            
            console.log({constraints})
            // const mediaStream = await navigator.mediaDevices.getUserMedia(constraints)
            navigator.mediaDevices.getUserMedia(constraints)
            .then(function (mediaStream) {
                console.log("%c Line:275 🌭 mediaStream", "color:#6ec1c2", mediaStream);
                var video = document.querySelector('video');
                stream = mediaStream;
                video.srcObject = mediaStream;
                video.onloadedmetadata = function (e) {
                    video.play();
                };
            })
            .catch(function (err) {
                console.log(err)
            });
            // console.log({mediaStream})
            // var video = document.querySelector('video');
            // stream = mediaStream;
            // video.srcObject = mediaStream;
            // video.onloadedmetadata = function (e) {
            //     video.play();
            // };
        }



        function native_detect() {
            console.log(' native_detect')
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var hint = document.getElementById("hint");
            var error_code_div = document.getElementById("error-code");
            var stage_div = document.getElementById("liveness-stage");

            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var data = imageData.data;

            HEAPU8.set(data, dst);

            // var output_ptr = _acv_detect999(dst, canvas.width, canvas.height);
            const info = btoa(JSON.stringify(canvas.toDataURL('image/jpeg')));
            const intArray1 = intArrayFromString(info);
            const ptr1 = _malloc(intArray1.length);
            HEAPU8.set(intArray1, ptr1);
            // console.log('aaa:intArray1', imageData.data, canvas.toDataURL('image/jpeg'), {l:intArray1.length,ptr1})
            // var output_ptr = _acv_detect(dst, canvas.width, canvas.height);
            var output_ptr = _acv_live_detect(dst, canvas.width, canvas.height, ptr1);
            _free(ptr1);
            // var output_ptr = _acv_live_detect(dst, canvas.width, canvas.height, canvas.toDataURL('image/jpeg'));
            if (output_ptr != null) {
                var output = UTF8ToString(output_ptr)
                console.log({output});
                _free(output_ptr);
                hint.innerHTML = output;
                try {
                    var _output = JSON.parse(output);
                    console.log({_output})
                    error_code_div.innerHTML = "error code: " + _output['err_code'];
                    stage_div.innerHTML = "current stage: " + _output['stage_code'];
                } catch (e) {
                    return;
                }
            }

            // var result = HEAPU8.subarray(dst, dst + data.length);
            // imageData.data.set(result);
            // ctx.putImageData(imageData, 0, 0);
            // 创建一个新的 Canvas 元素
            // var canvas2 = document.createElement('canvas');
            // canvas2.width = id.width;
            // canvas2.height = id.height;

            // // 将 imageData 绘制到 Canvas 上
            // var ctx = canvas2.getContext('2d');
            // ctx.putImageData(id, 0, 0);

            // // 将 Canvas 转换为 base64 图片
            // var base64Image = canvas.toDataURL();

            // console.log(base64Image);
        }

        //Request Animation Frame function
        var sFilter = function () {
            if (video.paused || video.ended) return;

            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(video, 0, 0, w, h);

            // native_detect();
            fpsIntervalDetect()

            window.requestAnimationFrame(sFilter);
        }

        // const fps = 30 // 1s 30帧
        const fps = 1 // 1s 1帧
        const fpsInterval = 1000 / fps // 1000=1s
        var now = 0
        var then = 0
        var past = 0
        function fpsIntervalDetect() {
            now = window.performance.now()
            past = now - then
            if (past > fpsInterval) {
                then = now - (past % fpsInterval)
                // save_info();
                native_detect();
            }
        }
        window.livenessProcessResult = (res) => {
            console.log('window.livenessProcessResult', res)
        }
        function save_info() {
            // const configText = btoa(JSON.stringify({
            //     ua: window.navigator.userAgent,
            // }));
            // const intArray = intArrayFromString(configText);
            // const ptr = _malloc(intArray.length);
            // HEAPU8.set(intArray, ptr);

            // const info = _acv_live_detect(ptr);
            // console.log({ info })
            // if (info) {
            //     var errText = UTF8ToString(err);
            //     _free(errText);
            // }
            // _free(ptr);
        }
    </script>

</body>

</html>
